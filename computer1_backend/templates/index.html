<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Program</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="app">
        <!-- Three.js Animation Canvas - Now full screen -->
        <section id="animation-section">
            <!-- Black Filter Overlay - MOVED inside animation section for fullscreen support -->
            <div id="black-filter-overlay"></div>
            
            <div id="three-canvas-container">
                <!-- Three.js canvas will be inserted here -->
            </div>
        </section>

        <!-- üñ§ NEW: Fullscreen mode hint -->
        <div class="fullscreen-hint">
            Press F for fullscreen
        </div>

        <!-- Debug Panel Toggle Button -->
        <button id="debug-toggle" class="debug-toggle-btn">
            <span>üîß</span>
        </button>

        <!-- üé≠ NEW: Cue System Debug Panel (Left Side) -->
        <section id="cue-debug-panel" class="cue-debug-panel-expanded">
            <div class="cue-debug-header">
                <h3>üé≠ Cue System Monitor</h3>
                <button id="cue-debug-close" class="cue-debug-close-btn">√ó</button>
            </div>
            
            <!-- Real-time Cue Status -->
            <div class="cue-debug-section">
                <h4>üéµ Live Status</h4>
                <div class="cue-status-grid">
                    <div class="status-item">
                        <span class="status-label">Audio Context:</span>
                        <span id="cue-audio-context-status" class="status-value">Unknown</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Performance State:</span>
                        <span id="cue-performance-state" class="status-value">Idle</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Current Phase:</span>
                        <span id="cue-current-phase" class="status-value">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Active Cues:</span>
                        <span id="cue-active-count" class="status-value">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">SD Insert Count:</span>
                        <span id="cue-sd-count" class="status-value">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Traffic Light Rate:</span>
                        <span id="cue-traffic-rate" class="status-value">0.75x</span>
                    </div>
                </div>
            </div>

            <!-- Cue Sequence Progress -->
            <div class="cue-debug-section">
                <h4>üìã Cue Sequence</h4>
                <div class="cue-sequence-list" id="cue-sequence-list">
                    <div class="cue-item" data-cue="CUE-01">
                        <span class="cue-number">01</span>
                        <span class="cue-name">Opening (Heartbeat + Riser)</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-02">
                        <span class="cue-number">02</span>
                        <span class="cue-name">Stop Opening Tracks</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-03">
                        <span class="cue-number">03</span>
                        <span class="cue-name">Sublimation Completed</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-04">
                        <span class="cue-number">04</span>
                        <span class="cue-name">Protocol + Black Filter</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item manual" data-cue="CUE-05">
                        <span class="cue-number">05</span>
                        <span class="cue-name">Spirit Mining (MANUAL)</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-06">
                        <span class="cue-number">06</span>
                        <span class="cue-name">Traffic Light Start</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item interactive" data-cue="SD-PHASE">
                        <span class="cue-number">üì±</span>
                        <span class="cue-name">SD Card Interactive Phase</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-07">
                        <span class="cue-number">07</span>
                        <span class="cue-name">Traffic Light Fade</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-08">
                        <span class="cue-number">08</span>
                        <span class="cue-name">Spirits + Convergence</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-09">
                        <span class="cue-number">09</span>
                        <span class="cue-name">Sublimation Initiated</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-10">
                        <span class="cue-number">10</span>
                        <span class="cue-name">Heartbeat Return</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-11">
                        <span class="cue-number">11</span>
                        <span class="cue-name">Final Riser</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-12">
                        <span class="cue-number">12</span>
                        <span class="cue-name">Departure Trigger</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-13">
                        <span class="cue-number">13</span>
                        <span class="cue-name">Heartbeat Stop</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-14">
                        <span class="cue-number">14</span>
                        <span class="cue-name">Final Sublimation</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-15">
                        <span class="cue-number">15</span>
                        <span class="cue-name">Long Season Fade In</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                    <div class="cue-item" data-cue="CUE-16">
                        <span class="cue-number">16</span>
                        <span class="cue-name">Long Season End + Blackout</span>
                        <span class="cue-status">‚è∏Ô∏è</span>
                    </div>
                </div>
            </div>

            <!-- Manual Controls -->
            <div class="cue-debug-section">
                <h4>üéÆ Manual Controls</h4>
                <div class="cue-controls-grid">
                    <button id="cue-start-sequence" class="cue-control-btn primary">‚ñ∂Ô∏è Start Sequence</button>
                    <button id="cue-trigger-05" class="cue-control-btn manual">üéµ Trigger CUE-05</button>
                    <button id="cue-emergency-stop" class="cue-control-btn danger">üõë Emergency Stop</button>
                    <button id="cue-reset-system" class="cue-control-btn">‚Ü∫ Reset System</button>
                </div>
                
                <!-- üé≠ NEW: Virtual SD Insert Testing -->
                <div class="virtual-sd-controls">
                    <h5>üì± Virtual SD Insert Testing</h5>
                    <div class="sd-insert-controls">
                        <label for="virtual-sd-count">SD Insert Count:</label>
                        <div class="sd-count-control">
                            <input type="number" id="virtual-sd-count" min="0" max="99" value="0" readonly>
                            <button id="virtual-sd-increment" class="cue-control-btn small">+1 SD Insert</button>
                            <button id="virtual-sd-reset" class="cue-control-btn small">Reset Count</button>
                        </div>
                        <div class="sd-insert-info">
                            <small>Simulates SD card insertion events for testing cue triggers</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audio Track Status -->
            <div class="cue-debug-section">
                <h4>üéµ Audio Tracks</h4>
                <div class="audio-tracks-list" id="cue-audio-tracks">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Event Log -->
            <div class="cue-debug-section">
                <h4>üìù Event Log</h4>
                <div class="cue-event-log" id="cue-event-log">
                    <div class="log-entry">System initialized</div>
                </div>
                <button id="cue-clear-log" class="cue-control-btn small">Clear Log</button>
            </div>
        </section>

        <!-- Cue Debug Panel Toggle Button (Left Side) -->
        <button id="cue-debug-toggle" class="cue-debug-toggle-btn">
            <span>üé≠</span>
        </button>

        <!-- Debug Panel (full height, collapsible) -->
        <section id="debug-panel" class="debug-panel-expanded">
            <div class="debug-header">
                <h3>Debug Panel</h3>
                <button id="debug-close" class="debug-close-btn">√ó</button>
            </div>
            
            <!-- Status Section -->
            <div class="debug-section">
                <h4>System Status</h4>
                <div class="status-info">
                    <div class="status-item">
                        <span>Connection:</span>
                        <span id="connection-status">Connecting...</span>
                    </div>
                    <div class="status-item">
                        <span>Image Processor:</span>
                        <span id="processor-status">Unknown</span>
                    </div>
                    <div class="status-item">
                        <span>File Monitoring:</span>
                        <span id="monitoring-status">Unknown</span>
                    </div>
                    <div class="status-item">
                        <span>SD Card Monitor:</span>
                        <span id="sd-monitor-status">Unknown</span>
                    </div>
                    <div class="status-item">
                        <span>Keyboard Trigger:</span>
                        <span id="keyboard-status">Unknown</span>
                    </div>
                </div>
            </div>

            <!-- SD Card Section (Collapsible) -->
            <div class="debug-section">
                <div class="section-header" onclick="toggleSection('sd-card-section')">
                    <h4>üíæ SD Card Management</h4>
                    <span class="toggle-arrow" id="sd-card-section-arrow">‚ñº</span>
                </div>
                <div id="sd-card-section" class="collapsible-content">
                    <div class="sd-card-status">
                        <div class="status-item">
                            <span>Cards Connected:</span>
                            <span id="sd-cards-count">0</span>
                        </div>
                        <div class="status-item">
                            <span>Import Status:</span>
                            <span id="import-status">Ready</span>
                        </div>
                    </div>
                    
                    <!-- Auto-Import Configuration -->
                    <div class="config-group">
                        <h5>ü§ñ Auto-Import Settings</h5>
                        <div class="config-item">
                            <div class="config-label">
                                <span>Auto-Import:</span>
                                <span class="config-description">Automatically import new images when SD card is detected</span>
                            </div>
                            <div class="config-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-import-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="auto-import-status" class="config-status">Enabled</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="sd-cards-container">
                        <!-- SD card info will be dynamically added here -->
                        <div id="no-cards-message" class="info-message">
                            No SD cards detected. Insert an SD card and click "Scan for Cards".
                        </div>
                    </div>
                    
                    <div class="sd-card-controls">
                        <div class="button-group">
                            <button id="scan-sd-cards">Scan for Cards</button>
                            <button id="refresh-sd-status">Refresh Status</button>
                        </div>
                    </div>
                    
                    <!-- Import Progress Section -->
                    <div id="import-progress-container" style="display: none;">
                        <h5>Import Progress</h5>
                        <div class="progress-bar">
                            <div id="import-progress-bar" class="progress-fill"></div>
                        </div>
                        <div class="progress-info">
                            <span id="import-progress-text">0% - Preparing...</span>
                        </div>
                        <div class="import-details">
                            <div>Current File: <span id="current-import-file">-</span></div>
                            <div>Imported: <span id="imported-count">0</span> | Remaining: <span id="remaining-count">0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Eye Images Section (Collapsible) -->
            <div class="debug-section">
                <div class="section-header" onclick="toggleSection('eye-section')">
                    <h4>Eyes from the Audience</h4>
                    <span class="toggle-arrow" id="eye-section-arrow">‚ñº</span>
                </div>
                <div id="eye-section" class="collapsible-content">
                    <div id="eye-images-container">
                        <!-- Eye images will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Debug Controls Section (Collapsible) -->
            <div class="debug-section">
                <div class="section-header" onclick="toggleSection('debug-controls-section')">
                    <h4>üîß Debug Controls</h4>
                    <span class="toggle-arrow" id="debug-controls-section-arrow">‚ñº</span>
                </div>
                <div id="debug-controls-section" class="collapsible-content">
                    <!-- Visual Effects Configuration -->
                    <div class="config-group">
                        <h5>üé≠ Visual Effects Settings</h5>
                        <div class="config-item">
                            <div class="config-label">
                                <span>Enhanced Flow Dynamics:</span>
                                <span class="config-description">Advanced particle flow system that prevents belt formation</span>
                            </div>
                            <div class="config-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="flow-dynamics-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="flow-dynamics-status" class="config-status">Enabled</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>‚ú® Bloom Post-Processing:</span>
                                <span class="config-description">Professional bloom effects for constant particle emission</span>
                            </div>
                            <div class="config-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="bloom-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="bloom-status" class="config-status">Enabled</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>üåü Constant Emission:</span>
                                <span class="config-description">Particles continuously emit light like bulbs for bloom effect</span>
                            </div>
                            <div class="config-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="constant-emission-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="constant-emission-status" class="config-status">Enabled</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-group">
                        <h5>üì∑ Camera Rotation Monitor</h5>
                        <div class="config-item">
                            <div class="config-label">
                                <span>Rotation Status:</span>
                                <span class="config-description">Current camera rotation state and speed</span>
                            </div>
                            <div class="config-control">
                                <span id="camera-rotation-status" class="rotation-status active">Medium Rotation</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Current Speed:</span>
                                <span class="config-description">Real-time rotation speed percentage</span>
                            </div>
                            <div class="config-control">
                                <span id="camera-rotation-speed" class="speed-indicator">45.2%</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Shape Count:</span>
                                <span class="config-description">Current shapes vs maximum (drives speed)</span>
                            </div>
                            <div class="config-control">
                                <span id="camera-speed-shape-count" class="shape-count">18/40</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Speed Progress:</span>
                                <span class="config-description">Visual indicator of camera acceleration</span>
                            </div>
                            <div class="config-control">
                                <div class="camera-speed-progress-container">
                                    <div id="camera-speed-progress" class="camera-speed-bar speed-medium" style="width: 45%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-group">
                        <h5>üéÆ Animation Controls</h5>
                        <div class="config-controls">
                            <div class="button-group">
                                <button id="test-connection">Test Connection</button>
                                <button id="test-processing">Test Image Processing</button>
                                <button id="test-animation">Test Animation Trigger</button>
                            </div>
                            <div class="button-group">
                                <button id="clear-eyes">Clear Eye Images</button>
                                <button id="clear-debug">Clear Debug Messages</button>
                                <button id="refresh-eyes">Refresh Eye Images</button>
                            </div>
                            <div class="button-group">
                                <button id="reset-animation">Reset Animation</button>
                                <button id="test-shell-effect">Test Shell Effect</button>
                                <button id="test-dispersion">Test Dispersion</button>
                                <button onclick="client.sendTestMessage()">Send Test Message</button>
                            </div>
                            <div class="button-group">
                                <button onclick="client.requestTestProcessing()">Test Processing</button>
                                <button onclick="client.requestStatusUpdate()">Refresh Status</button>
                            </div>
                        </div>
                    </div>

                    <!-- üïê NEW: Portal Departure Controls -->
                    <div class="config-group">
                        <h5>üåÄ Portal Departure System</h5>
                        <div class="portal-controls">
                            <div class="config-item">
                                <div class="config-label">
                                    <span>Portal Countdown:</span>
                                    <span class="config-description">Auto-trigger countdown timer</span>
                                </div>
                                <div class="config-control">
                                    <span id="portal-countdown" class="countdown-display countdown-inactive">--:--</span>
                                </div>
                            </div>
                            <div class="config-item">
                                <div class="config-label">
                                    <span>System Status:</span>
                                    <span class="config-description">Current auto-trigger state</span>
                                </div>
                                <div class="config-control">
                                    <span id="portal-status" class="portal-status">Inactive</span>
                                </div>
                            </div>
                            <div class="config-controls">
                                <div class="button-group">
                                    <button id="test-portal-departure">Test Portal Departure</button>
                                </div>
                                <div class="portal-instructions">
                                    <p>üí° When countdown is active, press ‚Üì (down arrow) key to trigger manually</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üñ§ NEW: Black Filter Controls -->
                    <div class="config-group">
                        <h5>üñ§ Black Filter Overlay</h5>
                        <div class="config-item">
                            <div class="config-label">
                                <span>Filter Status:</span>
                                <span class="config-description">Current state of the black screen overlay</span>
                            </div>
                            <div class="config-control">
                                <span id="black-filter-status" class="config-status enabled">Active</span>
                            </div>
                        </div>
                        <div class="config-controls">
                            <div class="button-group">
                                <button id="remove-black-filter">üñ§ Reveal Digital Space</button>
                                <button id="reset-black-filter">üîÑ Reset Filter</button>
                            </div>
                            <div class="portal-instructions">
                                <p>üí° Click to fade out the black overlay and reveal the digital program</p>
                                <p>üîÑ Use Reset to restore black filter to normal mode after cue system use</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üéµ NEW: Audio System Controls (Collapsible) -->
            <div class="debug-section">
                <div class="section-header" onclick="toggleSection('audio-system-section')">
                    <h4>üéµ Audio System</h4>
                    <span class="toggle-arrow" id="audio-system-section-arrow">‚ñº</span>
                </div>
                <div id="audio-system-section" class="collapsible-content">
                    <!-- Audio System Status -->
                    <div class="config-group">
                        <h5>üìä System Status</h5>
                        <div class="config-item">
                            <div class="config-label">
                                <span>Audio Context:</span>
                                <span class="config-description">Web Audio API initialization status</span>
                            </div>
                            <div class="config-control">
                                <span id="audio-context-status" class="config-status">Unknown</span>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">
                                <span>Tracks Loaded:</span>
                                <span class="config-description">Number of audio files successfully loaded</span>
                            </div>
                            <div class="config-control">
                                <span id="audio-tracks-loaded" class="config-value">0/0</span>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">
                                <span>Master Volume:</span>
                                <span class="config-description">Global audio volume level</span>
                            </div>
                            <div class="config-control">
                                <input type="range" id="master-volume-slider" min="0" max="100" value="100" class="config-range">
                                <span id="master-volume-value" class="config-value">100%</span>
                            </div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">
                                <span>Mute Status:</span>
                                <span class="config-description">Current mute state</span>
                            </div>
                            <div class="config-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="master-mute-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="mute-status" class="config-status">Unmuted</span>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Track Playback -->
                    <div class="config-group">
                        <h5>üéÆ Manual Track Playback</h5>
                        <div class="audio-track-list">
                            <div class="audio-track-item">
                                <div class="track-info">
                                    <span class="track-name">üé¨ Traffic Light</span>
                                    <span class="track-details">Manual test track</span>
                                </div>
                                <div class="track-controls">
                                    <button class="track-play-btn" data-track-id="traffic-light">‚ñ∂ Play</button>
                                    <button class="track-stop-btn" data-track-id="traffic-light">‚èπ Stop</button>
                                    <span class="track-status" id="traffic-light-status">Ready</span>
                                </div>
                            </div>
                            <div class="audio-track-item">
                                <div class="track-info">
                                    <span class="track-name">üåÖ Ambient Intro</span>
                                    <span class="track-details">Phase 1 background ambient</span>
                                </div>
                                <div class="track-controls">
                                    <button class="track-play-btn" data-track-id="ambient-intro">‚ñ∂ Play</button>
                                    <button class="track-stop-btn" data-track-id="ambient-intro">‚èπ Stop</button>
                                    <span class="track-status" id="ambient-intro-status">Ready</span>
                                </div>
                            </div>
                            <div class="audio-track-item">
                                <div class="track-info">
                                    <span class="track-name">üëÅÔ∏è Emergence Sound</span>
                                    <span class="track-details">Phase 2 eye shape emergence</span>
                                </div>
                                <div class="track-controls">
                                    <button class="track-play-btn" data-track-id="emergence-sound">‚ñ∂ Play</button>
                                    <button class="track-stop-btn" data-track-id="emergence-sound">‚èπ Stop</button>
                                    <span class="track-status" id="emergence-sound-status">Ready</span>
                                </div>
                            </div>
                            <div class="audio-track-item">
                                <div class="track-info">
                                    <span class="track-name">‚ö° Convergence Build</span>
                                    <span class="track-details">Phase 3 tension building</span>
                                </div>
                                <div class="track-controls">
                                    <button class="track-play-btn" data-track-id="convergence-build">‚ñ∂ Play</button>
                                    <button class="track-stop-btn" data-track-id="convergence-build">‚èπ Stop</button>
                                    <span class="track-status" id="convergence-build-status">Ready</span>
                                </div>
                            </div>
                            <div class="audio-track-item">
                                <div class="track-info">
                                    <span class="track-name">üåÄ Portal Departure</span>
                                    <span class="track-details">Phase 5 final dramatic moment</span>
                                </div>
                                <div class="track-controls">
                                    <button class="track-play-btn" data-track-id="portal-departure">‚ñ∂ Play</button>
                                    <button class="track-stop-btn" data-track-id="portal-departure">‚èπ Stop</button>
                                    <span class="track-status" id="portal-departure-status">Ready</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cue System Controls -->
                    <div class="config-group">
                        <h5>üé≠ Cue System</h5>
                        <div class="config-item">
                            <div class="config-label">
                                <span>Active Cues:</span>
                                <span class="config-description">Number of triggered cues</span>
                            </div>
                            <div class="config-control">
                                <span id="active-cues-count" class="config-value">0/0</span>
                            </div>
                        </div>
                        <div class="config-controls">
                            <div class="button-group">
                                <button id="trigger-manual-cue">üéµ Trigger Manual Cue</button>
                                <button id="reset-cue-system">‚Ü∫ Reset Cues</button>
                                <button id="emergency-stop-audio">üõë Emergency Stop</button>
                            </div>
                        </div>
                    </div>

                    <!-- Keyboard Controls Reference -->
                    <div class="config-group">
                        <h5>‚å®Ô∏è Keyboard Controls</h5>
                        <div class="keyboard-controls-ref">
                            <div class="keyboard-item">
                                <span class="key">‚Üí</span>
                                <span class="description">Trigger next manual cue</span>
                            </div>
                            <div class="keyboard-item">
                                <span class="key">M</span>
                                <span class="description">Mute/unmute audio</span>
                            </div>
                            <div class="keyboard-item">
                                <span class="key">+</span>
                                <span class="description">Volume up</span>
                            </div>
                            <div class="keyboard-item">
                                <span class="key">-</span>
                                <span class="description">Volume down</span>
                            </div>
                            <div class="keyboard-item">
                                <span class="key">Esc</span>
                                <span class="description">Emergency stop all audio</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debug Messages Section (Collapsible) -->
            <div class="debug-section">
                <div class="section-header" onclick="toggleSection('debug-messages-section')">
                    <h4>üìù Debug Messages</h4>
                    <span class="toggle-arrow" id="debug-messages-section-arrow">‚ñº</span>
                </div>
                <div id="debug-messages-section" class="collapsible-content">
                    <div id="debug-messages"></div>
                </div>
            </div>

            <!-- Artistic Processing Controls (Collapsible) -->
            <div class="debug-section">
                <div class="section-header" onclick="toggleSection('artistic-config-section')">
                    <h4>üé® Artistic Texture Processing</h4>
                    <span class="toggle-arrow" id="artistic-config-section-arrow">‚ñº</span>
                </div>
                <div id="artistic-config-section" class="collapsible-content">
                    <div class="config-group">
                        <h5>üé® Real-Time Edge Processing</h5>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Enable Processing:</span>
                                <span class="config-description">Transforms eye textures into dramatic black & white edge outlines</span>
                            </div>
                            <div class="config-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="artistic-enabled" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="artistic-status" class="config-status enabled">Enabled</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Edge Detection Method:</span>
                                <span class="config-description">Choose the edge detection algorithm for processing</span>
                            </div>
                            <div class="config-control">
                                <select id="edge-method" class="config-select">
                                    <option value="sobel" selected>Sobel (Recommended)</option>
                                    <option value="roberts">Roberts (Fast)</option>
                                    <option value="prewitt">Prewitt (Smooth)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Edge Threshold:</span>
                                <span class="config-description">Higher values = fewer, stronger edges. Lower = more detailed edges</span>
                            </div>
                            <div class="config-control">
                                <input type="range" id="edge-threshold" min="0.1" max="1.0" step="0.1" value="0.3" class="config-range">
                                <span id="threshold-value" class="config-value">0.3</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Edge Strength:</span>
                                <span class="config-description">Intensity of the edge detection effect</span>
                            </div>
                            <div class="config-control">
                                <input type="range" id="edge-strength" min="1.0" max="5.0" step="0.5" value="2.0" class="config-range">
                                <span id="strength-value" class="config-value">2.0</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Contrast:</span>
                                <span class="config-description">Overall contrast adjustment for the processed texture</span>
                            </div>
                            <div class="config-control">
                                <input type="range" id="contrast-factor" min="1.0" max="4.0" step="0.1" value="2.5" class="config-range">
                                <span id="contrast-value" class="config-value">2.5</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Gamma Correction:</span>
                                <span class="config-description">Brightness and midtone adjustment</span>
                            </div>
                            <div class="config-control">
                                <input type="range" id="gamma-correction" min="0.5" max="2.0" step="0.1" value="1.3" class="config-range">
                                <span id="gamma-value" class="config-value">1.3</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-group">
                        <h5>üé≠ Artistic Style</h5>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Visual Style:</span>
                                <span class="config-description">Choose between different edge style presentations</span>
                            </div>
                            <div class="config-control">
                                <select id="invert-edges" class="config-select">
                                    <option value="false" selected>Black edges on white</option>
                                    <option value="true">White edges on black</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Edge Thickness:</span>
                                <span class="config-description">Thickness of the detected edge lines</span>
                            </div>
                            <div class="config-control">
                                <input type="range" id="edge-thickness" min="1" max="5" step="1" value="1" class="config-range">
                                <span id="thickness-value" class="config-value">1</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Noise Reduction:</span>
                                <span class="config-description">Reduces noise in the processed texture for cleaner edges</span>
                            </div>
                            <div class="config-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="noise-reduction" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="noise-status" class="config-status enabled">Enabled</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Edge Smoothing:</span>
                                <span class="config-description">Smooths edge transitions for more refined output</span>
                            </div>
                            <div class="config-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="edge-smoothing" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="smoothing-status" class="config-status enabled">Enabled</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-group">
                        <h5>‚ú® 3D Enhancement</h5>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Edge Glow Effect:</span>
                                <span class="config-description">Adds subtle emissive glow to texture edges for enhanced visual impact</span>
                            </div>
                            <div class="config-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="edge-glow" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="glow-status" class="config-status enabled">Enabled</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Glow Intensity:</span>
                                <span class="config-description">Strength of the edge glow emissive effect</span>
                            </div>
                            <div class="config-control">
                                <input type="range" id="glow-intensity" min="0.1" max="1.0" step="0.1" value="0.3" class="config-range">
                                <span id="glow-intensity-value" class="config-value">0.3</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-group">
                        <h5>‚öôÔ∏è Processing Controls</h5>
                        <div class="config-controls">
                            <div class="button-group">
                                <button id="apply-artistic-processing">üé® Apply to All Shapes</button>
                                <button id="clear-processing-cache">üóëÔ∏è Clear Cache</button>
                                <button id="reset-artistic-defaults">‚Ü∫ Reset to Defaults</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-Time Processed Texture Display (Collapsible) -->
            <div class="debug-section">
                <div class="section-header" onclick="toggleSection('texture-display-section')">
                    <h4>üñºÔ∏è Real-Time Texture Preview</h4>
                    <span class="toggle-arrow" id="texture-display-section-arrow">‚ñº</span>
                </div>
                <div id="texture-display-section" class="collapsible-content">
                    <div class="config-group">
                        <h5>üì∏ Live Texture Processing</h5>
                        <div class="texture-display-info">
                            <div class="status-item">
                                <span>Processing Status:</span>
                                <span id="texture-processing-status" class="status-ready">Ready</span>
                            </div>
                            <div class="status-item">
                                <span>Processed Textures:</span>
                                <span id="texture-count">0</span>
                            </div>
                            <div class="status-item">
                                <span>Last Updated:</span>
                                <span id="last-texture-update">Never</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-group">
                        <h5>üîÑ Auto-Refresh Controls</h5>
                        <div class="config-item">
                            <div class="config-label">
                                <span>Auto-Refresh:</span>
                                <span class="config-description">Automatically update texture preview when new images are processed</span>
                            </div>
                            <div class="config-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-refresh-textures" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="auto-refresh-status" class="config-status enabled">Enabled</span>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">
                                <span>Refresh Interval:</span>
                                <span class="config-description">How often to check for new processed textures (seconds)</span>
                            </div>
                            <div class="config-control">
                                <input type="range" id="refresh-interval" min="1" max="10" step="1" value="3" class="config-range">
                                <span id="refresh-interval-value" class="config-value">3s</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-group">
                        <h5>üñºÔ∏è Texture Gallery</h5>
                        <div class="texture-gallery-container">
                            <div id="processed-textures-grid" class="processed-textures-grid">
                                <div class="texture-placeholder">
                                    <div class="placeholder-icon">üé®</div>
                                    <div class="placeholder-text">No processed textures yet</div>
                                    <div class="placeholder-subtext">Upload some eye images to see processed textures here</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-group">
                        <h5>‚öôÔ∏è Display Controls</h5>
                        <div class="config-controls">
                            <div class="button-group">
                                <button id="refresh-texture-preview">üîÑ Refresh Now</button>
                                <button id="clear-texture-gallery">üóëÔ∏è Clear Gallery</button>
                                <button id="download-processed-texture">üíæ Download Latest</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flow Dynamics Configuration (Collapsible) -->
            <div class="debug-section">
                <div class="section-header" onclick="toggleSection('flow-dynamics-section')">
                    <h4>üåä Enhanced Flow Dynamics</h4>
                    <span class="toggle-arrow" id="flow-dynamics-section-arrow">‚ñº</span>
                </div>
                <div id="flow-dynamics-section" class="collapsible-content">
                    <div class="config-item">
                        <div class="config-label">
                            <span>Enhanced Flow Dynamics:</span>
                            <span class="config-description">Advanced particle flow system with balanced attraction forces</span>
                        </div>
                        <div class="config-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="flow-dynamics-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span id="flow-dynamics-status" class="config-status enabled">Enabled</span>
                        </div>
                    </div>
                    <div class="config-description-text">
                        When enabled, particles flow naturally around all eye shapes with turbulence, repulsion, and circulation forces for organic movement patterns.
                    </div>
                </div>
            </div>

            <!-- üîÑ NEW: Morphing Controls Configuration (Collapsible) -->
            <div class="debug-section">
                <div class="section-header" onclick="toggleSection('morphing-section')">
                    <h4>üîÑ Organic Shape Morphing (Vertex Noise)</h4>
                    <span class="toggle-arrow" id="morphing-section-arrow">‚ñº</span>
                </div>
                <div id="morphing-section" class="collapsible-content">
                    <div class="config-item">
                        <div class="config-label">
                            <span>Shape Morphing:</span>
                            <span class="config-description">Organic vertex noise for constantly changing mesh shapes</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="morphing-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="config-status enabled" id="morphing-status">Enabled</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Noise Animation Speed:</span>
                            <span class="config-description">How fast the vertex noise animates over time</span>
                        </div>
                        <input type="range" id="morphing-speed" min="0.1" max="5.0" step="0.1" value="1.0">
                        <span class="config-value" id="morphing-speed-value">1.0</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Noise Intensity:</span>
                            <span class="config-description">Overall strength of vertex displacement</span>
                        </div>
                        <input type="range" id="morphing-intensity" min="0.0" max="1.0" step="0.05" value="0.5">
                        <span class="config-value" id="morphing-intensity-value">0.5</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Noise Frequency:</span>
                            <span class="config-description">Detail level of the noise pattern (higher = more detailed)</span>
                        </div>
                        <input type="range" id="morphing-frequency" min="0.5" max="10.0" step="0.1" value="3.0">
                        <span class="config-value" id="morphing-frequency-value">3.0</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Noise Amplitude:</span>
                            <span class="config-description">Maximum displacement distance for vertices</span>
                        </div>
                        <input type="range" id="morphing-amplitude" min="0.01" max="1.0" step="0.01" value="0.25">
                        <span class="config-value" id="morphing-amplitude-value">0.25</span>
                    </div>
                    
                    <div class="config-stats">
                        <div class="config-stat">
                            <span>Active Morphing Shapes:</span>
                            <span id="morphing-active-shapes">0</span>
                        </div>
                        <div class="config-stat">
                            <span>Total Shapes:</span>
                            <span id="morphing-total-shapes">0</span>
                        </div>
                        <div class="config-stat">
                            <span>Regular Shapes:</span>
                            <span id="morphing-regular-shapes">0</span>
                        </div>
                    </div>
                    
                    <div class="config-controls">
                        <button id="convert-to-morphing">Convert All to Morphing</button>
                        <button id="test-morphing">Test Morphing</button>
                        <button id="test-extreme-morphing">üîç Test Extreme Morphing</button>
                        <button id="refresh-morphing-stats">Refresh Stats</button>
                    </div>
                </div>
            </div>

            <!-- üåÖ NEW: Emergence Animation Configuration (Collapsible) -->
            <div class="debug-section">
                <div class="section-header" onclick="toggleSection('emergence-section')">
                    <h4>üåÖ Shape Emergence Animation</h4>
                    <span class="toggle-arrow" id="emergence-section-arrow">‚ñº</span>
                </div>
                <div id="emergence-section" class="collapsible-content">
                    <div class="config-item">
                        <div class="config-label">
                            <span>Emergence Animation:</span>
                            <span class="config-description">New shapes appear gradually from transparent to visible</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="emergence-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="config-status enabled" id="emergence-status">Enabled</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Emergence Duration:</span>
                            <span class="config-description">How long shapes take to fully emerge (seconds)</span>
                        </div>
                        <input type="range" id="emergence-duration" min="0.5" max="10.0" step="0.1" value="2.5">
                        <span class="config-value" id="emergence-duration-value">2.5s</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Start Opacity:</span>
                            <span class="config-description">Initial transparency level for new shapes</span>
                        </div>
                        <input type="range" id="emergence-start-opacity" min="0.0" max="0.5" step="0.01" value="0.0">
                        <span class="config-value" id="emergence-start-opacity-value">0.0</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Target Opacity:</span>
                            <span class="config-description">Final opacity level after emergence</span>
                        </div>
                        <input type="range" id="emergence-target-opacity" min="0.5" max="1.0" step="0.01" value="0.75">
                        <span class="config-value" id="emergence-target-opacity-value">0.75</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Easing Function:</span>
                            <span class="config-description">Animation curve for emergence transition</span>
                        </div>
                        <select id="emergence-easing" class="config-select">
                            <option value="linear">Linear</option>
                            <option value="easeInOutCubic" selected>Ease In-Out Cubic</option>
                            <option value="easeInOutSine">Ease In-Out Sine</option>
                        </select>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Scale Effect:</span>
                            <span class="config-description">Enable scale animation during emergence</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="emergence-scale-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="config-status enabled" id="emergence-scale-status">Enabled</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Start Scale:</span>
                            <span class="config-description">Initial size multiplier for new shapes</span>
                        </div>
                        <input type="range" id="emergence-start-scale" min="0.1" max="1.0" step="0.01" value="0.8">
                        <span class="config-value" id="emergence-start-scale-value">0.8</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Rotation Effect:</span>
                            <span class="config-description">Enhanced rotation during emergence animation</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="emergence-rotation-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="config-status enabled" id="emergence-rotation-status">Enabled</span>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <span>Rotation Intensity:</span>
                            <span class="config-description">Multiplier for rotation speed during emergence</span>
                        </div>
                        <input type="range" id="emergence-rotation-intensity" min="0.0" max="1.0" step="0.05" value="0.3">
                        <span class="config-value" id="emergence-rotation-intensity-value">0.3</span>
                    </div>
                    
                    <div class="config-controls">
                        <button id="test-emergence">üåÖ Test Emergence</button>
                        <button id="reset-emergence-defaults">‚Ü∫ Reset Defaults</button>
                    </div>
                    
                    <div class="config-description-text">
                        New eye shapes will gradually emerge from complete transparency to their normal appearance over the specified duration, creating a more organic introduction of audience eye images.
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/three.min.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <!-- Post-processing libraries for bloom effects -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/shaders/CopyShader.js"></script>
    <!-- üéµ NEW: Sound system -->
    <script src="{{ url_for('static', filename='js/trafficLightController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/soundSystem.js') }}"></script>
    <script src="{{ url_for('static', filename='js/client.js') }}"></script>
    
    <script>
        // Debug panel toggle functionality - MODIFIED
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            const toggleBtn = document.getElementById('debug-toggle');
            
            panel.classList.toggle('debug-panel-hidden');
            panel.classList.toggle('debug-panel-expanded');
            
            if (panel.classList.contains('debug-panel-hidden')) {
                toggleBtn.classList.add('visible');
            } else {
                toggleBtn.classList.remove('visible');
            }
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const arrow = document.getElementById(sectionId + '-arrow');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                arrow.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                arrow.textContent = '‚ñ∂';
            }
        }

        // Initialize debug panel functionality - MODIFIED
        document.addEventListener('DOMContentLoaded', function() {
            // Set up debug panel toggle with black filter integration
            document.getElementById('debug-toggle').addEventListener('click', toggleDebugPanel);
            document.getElementById('debug-close').addEventListener('click', toggleDebugPanel);
            
            // Hide debug panel initially to ensure black filter is visible on load
            const panel = document.getElementById('debug-panel');
            if (panel) {
                panel.classList.add('debug-panel-hidden');
                panel.classList.remove('debug-panel-expanded');
            }
            
            // üé≠ NEW: Hide cue debug panel initially
            const cuePanel = document.getElementById('cue-debug-panel');
            if (cuePanel) {
                cuePanel.classList.add('cue-debug-panel-hidden');
                cuePanel.classList.remove('cue-debug-panel-expanded');
            }
            
            // üñ§ NEW: Black filter control button
            const blackFilterBtn = document.getElementById('remove-black-filter');
            if (blackFilterBtn) {
                blackFilterBtn.addEventListener('click', function() {
                    // Call the TheatreClient method if available
                    if (window.theatreClient && typeof window.theatreClient.fadeOutBlackFilter === 'function') {
                        window.theatreClient.fadeOutBlackFilter();
                        
                        // Update button and status
                        blackFilterBtn.disabled = true;
                        blackFilterBtn.textContent = 'üñ§ Filter Removed';
                        
                        const statusSpan = document.getElementById('black-filter-status');
                        if (statusSpan) {
                            statusSpan.textContent = 'Removed';
                            statusSpan.className = 'config-status disabled';
                        }
                    }
                });
            }
            
            // üÜï NEW: Black filter reset button
            const resetBlackFilterBtn = document.getElementById('reset-black-filter');
            if (resetBlackFilterBtn) {
                resetBlackFilterBtn.addEventListener('click', function() {
                    // Call the TheatreClient reset method if available
                    if (window.theatreClient && typeof window.theatreClient.resetBlackFilterToNormalMode === 'function') {
                        window.theatreClient.resetBlackFilterToNormalMode();
                    }
                });
            }
            
            console.log('Debug panel initialized with black filter integration');

            // Initialize all collapsible sections as open by default
            const sectionsToOpen = [
                'eye-section',
                'sd-card-section', 
                'debug-controls-section',
                'debug-messages-section',
                'artistic-config-section',
                'texture-display-section',
                'flow-dynamics-section',
                'morphing-section',
                'emergence-section',
                'audio-system-section'
            ];
            
            sectionsToOpen.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                const arrow = document.getElementById(sectionId + '-arrow');
                if (section && arrow) {
                    section.style.display = 'block';
                    arrow.textContent = '‚ñº';
                }
            });

            // Add F key fullscreen functionality
            document.addEventListener('keydown', function(event) {
                if (event.key === 'f' || event.key === 'F') {
                    event.preventDefault();
                    toggleFullscreen();
                }
            });

            // üñ§ NEW: Add fullscreen event listeners for better tracking
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        });

        // üñ§ NEW: Handle fullscreen state changes
        function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement || 
                                   document.webkitFullscreenElement || 
                                   document.mozFullScreenElement || 
                                   document.msFullscreenElement);
            
            console.log(`Fullscreen mode: ${isFullscreen ? 'ON' : 'OFF'}`);
            
            // Update the Three.js renderer if it exists
            if (window.theatreClient && window.theatreClient.renderer) {
                // Force resize to ensure proper rendering in fullscreen
                setTimeout(() => {
                    window.theatreClient.onWindowResize();
                }, 100);
            }
            
            // Log black filter status in fullscreen
            const blackFilter = document.getElementById('black-filter-overlay');
            if (blackFilter && isFullscreen) {
                console.log('üñ§ Black filter overlay present in fullscreen mode');
            }
        }

        // Fullscreen functionality for Three.js canvas
        function toggleFullscreen() {
            // üñ§ UPDATED: Use animation section instead of just canvas to include black filter
            const animationSection = document.getElementById('animation-section');
            
            if (!document.fullscreenElement) {
                // Enter fullscreen
                if (animationSection && animationSection.requestFullscreen) {
                    animationSection.requestFullscreen();
                } else if (animationSection && animationSection.webkitRequestFullscreen) {
                    animationSection.webkitRequestFullscreen();
                } else if (animationSection && animationSection.msRequestFullscreen) {
                    animationSection.msRequestFullscreen();
                }
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }
    </script>
</body>
</html> 